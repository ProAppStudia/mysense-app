<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" fill="clear" class="custom-back-button">
        <ion-icon name="arrow-back-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ isDoctorCardView(doctor) ? doctor.fullName : 'Профіль' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div *ngIf="doctor">
    <div *ngIf="isDoctorCardView(doctor); else errorView" class="psychologist-cards-container profile-page">
      <div class="psychologist-card">
      <div class="card-header">
        <img [src]="doctor.avatarUrl || 'assets/img/IMG_1743.jpeg'" alt="Psychologist" class="psychologist-avatar">
        <div class="header-info">
          <div class="online-offline-status">
            <span *ngIf="doctor.online" class="status-item online">
              <ion-icon src="assets/icon/onlain.svg"></ion-icon>
              Онлайн
            </span>
            <span *ngIf="doctor.inPerson" class="status-item offline">
              <ion-icon src="assets/icon/ochno.svg"></ion-icon>
              Очно
            </span>
          </div>
          <p *ngIf="doctor.city" class="location">{{ doctor.city }}</p>
          <h3 class="psychologist-name">{{ doctor.fullName }}</h3>
          <p *ngIf="doctor.verified" class="verified-specialist">
            <ion-icon src="assets/icon/verified.svg"></ion-icon>
            Перевірений фахівець
          </p>
        </div>
      </div>
      <p *ngIf="doctor.specialization" class="specialization">{{ doctor.specialization }}</p>
      <div class="stats">
        <span *ngIf="doctor.experienceYears" class="stat-item">
          <ion-icon src="assets/icon/praktika.svg"></ion-icon>
          {{ doctor.experienceYears }} років практики
        </span>
        <span *ngIf="doctor.sessionsCount" class="stat-item">
          <ion-icon src="assets/icon/session.svg"></ion-icon>
          {{ doctor.sessionsCount }}+ сесій
        </span>
      </div>
      <div class="feedback-and-intro">
        <span *ngIf="doctor?.reviewsCountText" class="feedback-item">
          <ion-icon src="assets/icon/otzyv.svg"></ion-icon>
          {{ doctor?.reviewsCountText }}
        </span>
        <span *ngIf="doctor.introMinutes" class="intro-item">
          <ion-icon src="assets/icon/hello.svg"></ion-icon>
          Знайомство {{ doctor.introMinutes }} хв
        </span>
      </div>
      <div class="pricing">
        <div *ngIf="doctor.priceIndividual" class="price-item">
          <p style="font-size: 14px; color: #9895a6; font-weight: 400;">Індивідуальна</p>
          <p class="price-value" style="color: #2f264d; font-size: 20px; font-weight: 500;">{{ doctor.priceIndividual }} <span class="currency" style="font-size: 14px; color: #9895a6; font-weight: 400;">грн.</span></p>
        </div>
        <div *ngIf="doctor.priceFamily" class="price-item">
          <p style="font-size: 14px; color: #9895a6; font-weight: 400;">Сімейна</p>
          <p class="price-value" style="color: #2f264d; font-size: 20px; font-weight: 500;">{{ doctor.priceFamily }} <span class="currency" style="font-size: 14px; color: #9895a6; font-weight: 400;">грн.</span></p>
        </div>
      </div>
      </div>
      <div class="psychologist-card">
      <div *ngIf="doctor.videoAppealUrl" class="video-container">
        <video controls [src]="doctor.videoAppealUrl" width="100%"></video>
      </div>

      <ion-button *ngIf="doctor.introMinutes" class="intro-button" expand="block" fill="outline" (click)="openChat('15min')">
        <ion-icon src="assets/icon/hello.svg" slot="start"></ion-icon>
        Домовитись про знайомство {{ doctor.introMinutes }} хв
      </ion-button>
      </div>
      <div class="psychologist-card">
      <div class="info-block">
        <h4 class="info-title-icon">
          <ion-icon src="assets/icon/zkem.svg"></ion-icon>
          З ким я працюю
        </h4>
        <ul>
          <li *ngFor="let type of doctor.workWithTypes">{{ type }}</li>
        </ul>
        <ng-container *ngIf="doctor.worksWithMilitary || doctor.worksWithLgbt">
        <h4 class="info-title-icon">
          <ion-icon src="assets/icon/star.svg"></ion-icon>
          Працюю з:
        </h4>
        <ul>
          <li *ngIf="doctor.worksWithMilitary">Військовими</li>
          <li *ngIf="doctor.worksWithLgbt">ЛГБТКІ+</li>
        </ul>
        </ng-container>
        <h4 class="info-title-icon">
          <ion-icon src="assets/icon/lang.svg"></ion-icon>
          Мова спілкування:
        </h4>
        <ul>
          <li *ngFor="let lang of doctor.languages">{{ lang }}</li>
        </ul>
      </div>
      </div>
      <div class="psychologist-card">
      <div class="info-block about-me">
        <h4 class="info-title-about">Про мене</h4>
        <div class="description" [class.expanded]="isDescriptionExpanded">
          <p>{{ doctor.description }}</p>
        </div>
        <button (click)="toggleDescription()" class="show-more-button">
          {{ isDescriptionExpanded ? 'Згорнути' : 'Показати більше' }}
        </button>
      </div>
      </div>
      <div class="psychologist-card">
      <div class="info-block">
         <div class="work-with" [class.expanded]="isWorkwithExpanded">
        <h4 class="info-title">Я працюю з:</h4>
        <ul>
          <li *ngFor="let item of doctor.worksWith">{{ item }}</li>
        </ul>
        
      </div>
      <button (click)="toggleWorkwith()" class="show-more-button">
          {{ isWorkwithExpanded ? 'Згорнути' : 'Показати більше' }}
        </button>
      </div>
      </div>
<div class="psychologist-card">
      <div class="info-block">
        <h4 class="info-title">Я не працюю з:</h4>
        <ul>
          <li *ngFor="let item of doctor.doNotWorkWith" class="not-work-with">{{ item }}</li>
        </ul>
      </div>
</div>
      <div class="psychologist-card">
      <div class="info-block education-block">
        <h4 class="info-title">Освіта</h4>
        <div class="list-container education-list" [class.expanded]="isEducationExpanded">
          <div *ngFor="let uni of doctor.universities" class="education-item">
            <p class="date">{{ uni.date }}</p>
            <p class="name">{{ uni.name }}</p>
            <p class="speciality">{{ uni.speciality }}</p>
            <p class="checked">
              <ion-icon src="assets/icon/verified.svg"></ion-icon>
              {{ uni.checked }}
            </p>
          </div>
        </div>
        <button (click)="toggleEducation()" class="show-more-button" *ngIf="doctor.universities && doctor.universities.length > 2">
          {{ isEducationExpanded ? 'Згорнути' : 'Показати більше' }}
        </button>
      </div>

      <div class="diploma-gallery" *ngIf="doctor.doctorFiles && doctor.doctorFiles.length > 0">
        <swiper-container slides-per-view="auto" space-between="10">
          <swiper-slide *ngFor="let file of doctor.doctorFiles">
            <a [href]="file.file" target="_blank">
              <img [src]="file.thumb">
            </a>
          </swiper-slide>
        </swiper-container>
      </div>
</div>
    
      <div class="psychologist-card">
      <div #bookingBlock class="booking-block" *ngIf="doctor.calendar">
        <h3>Забронювати сесію</h3>
        <p class="timezone-info">Бронювання проводиться за київським часом</p>

        <div class="session-type-toggle">
          <button class="sessionbutton" [class.active]="sessionType === 'online'" (click)="sessionType = 'online'">Онлайн</button>
          <button *ngIf="doctor.inPerson" class="sessionbutton" [class.active]="sessionType === 'offline'" (click)="sessionType = 'offline'">Очно</button>
        </div>

        <div class="booking-for-toggle">
          <button
            *ngFor="let typeOption of availableBookingTypes"
            class="sessionbutton"
            [class.active]="bookingFor === typeOption.value"
            (click)="bookingFor = typeOption.value"
          >
            {{ typeOption.label }}
          </button>
        </div>

        <ng-container *ngIf="!showPairOnlineRequestBlock; else pairOnlineRequestBlock">
          <div class="week-navigator">
            <div class="week-nav-arrows">
              <button type="button" (click)="prevWeek()" [disabled]="!canGoPrevWeek()">
                <img
                  [src]="canGoPrevWeek() ? 'assets/icon/arrow-left-color.svg' : 'assets/icon/arrow-left-grey.svg'"
                  alt="Попередній тиждень"
                >
              </button>
              <button type="button" (click)="nextWeek()" [disabled]="!canGoNextWeek()">
                <img
                  [src]="canGoNextWeek() ? 'assets/icon/arrow-left-color.svg' : 'assets/icon/arrow-left-grey.svg'"
                  alt="Наступний тиждень"
                  class="week-btn-icon-next"
                >
              </button>
            </div>
            <span class="week-title">{{ currentWeek?.week }}</span>
          </div>

          <div class="calendar-grid" *ngIf="currentWeek">
            <div class="day-column" *ngFor="let dayKey of dayKeys">
              <div class="day-header">
                <p class="calendar-name">{{ currentWeek.days[dayKey].day_name }}</p>
                <p class="calendar-no">{{ currentWeek.days[dayKey].day_no }}</p>
              </div>
              <div class="time-slots">
                <button
                  *ngFor="let slot of currentWeek.days[dayKey].times"
                  [disabled]="isSlotDisabled(slot)"
                  [class.active]="isSlotSelected(dayKey, slot)"
                  (click)="selectSlot(dayKey, slot)"
                >
                  {{ slot.time }}:00
                </button>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #pairOnlineRequestBlock>
          <div class="pair-online-request">
            <p class="pair-online-request__text">
              Відправте запит і я звʼяжуся з вами найближчим часом, щоб домовитися про сесію
            </p>
            <button type="button" class="pair-online-request__btn" (click)="openChat('write')">
              Домовитися про сесію
            </button>
          </div>
        </ng-template>
      </div>
      </div>
      <div class="psychologist-card">
      <div class="info-block reviews-block">
        <h4 class="info-title">Відгуки клієнтів</h4>
        <div *ngIf="doctor.reviews && doctor.reviews.length > 0; else noReviews">
          <div class="list-container" [class.expanded]="isReviewsExpanded">
            <div *ngFor="let review of doctor.reviews" class="review-item">
              <div class="review-header">
                <div>
                  <span class="author">{{ review.author }}</span>
                  <span class="date">{{ review.date }}</span>
                </div>
                <ion-icon src="assets/icon/quetes-comment.svg" class="quote-icon"></ion-icon>
              </div>
              <p class="text">{{ review.text }}</p>
            </div>
          </div>
          <button (click)="toggleReviews()" class="show-more-button" *ngIf="doctor.reviews.length > 1">
            {{ isReviewsExpanded ? 'Згорнути' : 'Показати ще' }}
          </button>
        </div>
        <ng-template #noReviews>
          <p>Відгуків поки що немає.</p>
        </ng-template>
        <button class="leave-review-button" expand="block" fill="outline">Залишити відгук</button>
      </div>
      </div>
    </div>
    <ng-template #errorView>
      <p>Не вдалося завантажити профіль.</p>
    </ng-template>
  </div>
</ion-content>

<ion-footer>
  <div class="footer-buttons">
    <ion-button class="book-button" (click)="openSessionRequest()">
      <ion-icon slot="start" name="calendar-outline"></ion-icon>
      Забронювати зустріч
    </ion-button>
    <ion-button class="message-button" fill="outline" (click)="openChat('write')">
      <ion-icon slot="start" name="chatbubble-ellipses-outline"></ion-icon>
      Написати психологу
    </ion-button>
  </div>
</ion-footer>

<ion-content [fullscreen]="true">
  <div *ngIf="loading()" class="ion-text-center">
    <ion-spinner></ion-spinner>
    <p>Завантаження...</p>
  </div>

  <ng-container [ngSwitch]="view()">

    <!-- Вибір типу -->
    <ng-container *ngSwitchCase="'type'">
      <div class="progress-dots">
        <span class="dot" [class.active]="visualStep() >= 0"></span>
        <span class="dot" [class.active]="visualStep() >= 1"></span>
        <span class="dot" [class.active]="visualStep() >= 2"></span>
        <span class="dot" [class.active]="visualStep() >= 3"></span>
        <span class="dot" [class.active]="visualStep() >= 4"></span>
        <span class="dot" [class.active]="visualStep() >= 5"></span>
        <span class="dot" [class.active]="visualStep() >= 6"></span>
        <span class="dot" [class.active]="visualStep() >= 7"></span>
        <span class="dot" [class.active]="visualStep() >= 8"></span>
        <span class="dot" [class.active]="visualStep() >= 9"></span>
      </div>
      <h1 class="ion-text-center ion-padding-top">Для кого ви шукаєте підтримку?</h1>

      <div class="selection-card" (click)="pickType(1)" [class.selected]="answers.type === 1">
          <div class="card-content-wrapper individual">
            <span class="card-text">Для себе</span>
            <img src="assets/icon/Union.svg" alt="Individual" class="card-image">
          </div>
      </div>

      <div class="selection-card" (click)="pickType(2)" [class.selected]="answers.type === 2">
          <div class="card-content-wrapper family">
            <span class="card-text">Для пари / сім'ї</span>
            <img src="assets/icon/Union2.svg" alt="Family" class="card-image">
          </div>
      </div>

      <div class="selection-card" (click)="pickType(3)" [class.selected]="answers.type === 3">
          <div class="card-content-wrapper child">
            <span class="card-text">Для дитини / підлітка</span>
            <img src="assets/icon/Union3.svg" alt="Child" class="card-image">
          </div>
      </div>
    </ng-container>

    <!-- Інфо сторінка -->
    <ng-container *ngSwitchCase="'info'">
      <div class="progress-dots">
        <span class="dot" [class.active]="visualStep() >= 0"></span>
        <span class="dot" [class.active]="visualStep() >= 1"></span>
        <span class="dot" [class.active]="visualStep() >= 2"></span>
        <span class="dot" [class.active]="visualStep() >= 3"></span>
        <span class="dot" [class.active]="visualStep() >= 4"></span>
        <span class="dot" [class.active]="visualStep() >= 5"></span>
        <span class="dot" [class.active]="visualStep() >= 6"></span>
        <span class="dot" [class.active]="visualStep() >= 7"></span>
        <span class="dot" [class.active]="visualStep() >= 8"></span>
        <span class="dot" [class.active]="visualStep() >= 9"></span>
      </div>
      <div class="ion-text-center ion-padding-top">
        <img src="assets/icon/Frame1428.svg" alt="Intro" class="intro-image">
        <h1 class="ion-padding-top">Розкажіть нам про себе, щоб ми могли дати найкращу рекомендацію для вас.</h1>
        <p class="ion-padding-horizontal intro-p">Ми задаємо тільки ті запитання, які дійсно необхідні для якісного та персоналізованого підбору психолога.</p>
        <div class="privacy-guarantee">
          <svg viewBox="0 0 22 22" width="22" height="22" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M18.7022 5.78441L12.7878 3.24968C12.2847 3.03406 11.7153 3.03406 11.2122 3.24968L5.29778 5.78441C4.47855 6.13551 3.99051 6.98635 4.10106 7.87077L4.71405 12.7747C4.9342 14.5359 5.81517 16.1477 7.1787 17.284L10.7196 20.2347C11.4613 20.8528 12.5387 20.8528 13.2804 20.2347L16.8213 17.284C18.1848 16.1477 19.0658 14.5359 19.286 12.7747L19.8989 7.87077C20.0095 6.98635 19.5215 6.13551 18.7022 5.78441Z" stroke="#a89adf" stroke-width="2" stroke-linecap="round"></path>
<path d="M9 12L11.5687 14.5687C11.7918 14.7918 12.1633 14.7551 12.3383 14.4925L16 9" stroke="#a89adf" stroke-width="2" stroke-linecap="round"></path>
</svg>
          <p>Ми гарантуємо конфіденційність та надійний захист всіх даних, які ви залишаєте на платформі.</p>
        </div>
        <div class="ion-padding-horizontal ion-margin-top button-group">
          <ion-button fill="outline" (click)="prevStep()" class="back-button">
            <ion-icon name="arrow-back-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button expand="block" (click)="startTest()" class="next-button">Далі</ion-button>
        </div>
      </div>
    </ng-container>

    <!-- Крок тесту -->
    <ng-container *ngSwitchCase="'step'">
      <ion-header *ngIf="node">
        <ion-toolbar>
          <ion-buttons slot="start"><ion-back-button defaultHref="" (click)="prevStep()"></ion-back-button></ion-buttons>
          <ion-title>{{ node.header }}</ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-list *ngIf="node">
        <p *ngIf="node.subheader">{{ node.subheader }}</p>

        <!-- radio -->
        <ion-radio-group *ngIf="node.type==='radio' && node.options && !('min' in node.options)" [value]="answers[node.step_type]" (ionChange)="setRadio(node.step_type, $event.detail.value)">
          <ion-item *ngFor="let o of getOptionsAsArray(node)">
            <ion-label>{{ o.text || o.name }}</ion-label>
            <ion-radio slot="end" [value]="(o.id ?? o.value)"></ion-radio>
          </ion-item>
        </ion-radio-group>

        <!-- checkbox -->
        <ng-container *ngIf="node.type==='checkbox' && node.options && !('min' in node.options)">
          <ion-item *ngFor="let o of getOptionsAsArray(node)">
            <ion-checkbox slot="start"
              [checked]="(answers[node.step_type] || []).includes(o.id ?? o.value)"
              (ionChange)="toggleCheckbox(node.step_type, (o.id ?? o.value))">
            </ion-checkbox>
            <ion-label>{{ o.text || o.name }}</ion-label>
          </ion-item>
        </ng-container>

        <!-- range -->
        <ng-container *ngIf="node.type==='range' && node.options && ('min' in node.options)">
          <ion-item>
            <ion-range *ngIf="node.step_type === 'price'"
                       [min]="getRangeMin(node)" [max]="getRangeMax(node)"
                       [value]="{lower: answers['min_price'] || getRangeMin(node), upper: answers['max_price'] || getRangeMax(node)}"
                       (ionChange)="setRange(node.step_type, $event.detail.value)"
                       dualKnobs="true">
              <ion-label slot="start">{{ answers['min_price'] || getRangeMin(node) }}</ion-label>
              <ion-label slot="end">{{ answers['max_price'] || getRangeMax(node) }}</ion-label>
            </ion-range>
            <ion-range *ngIf="node.step_type !== 'price'"
                       [min]="getRangeMin(node)" [max]="getRangeMax(node)"
                       [value]="answers[node.step_type]"
                       (ionChange)="setRange(node.step_type, $event.detail.value)"></ion-range>
          </ion-item>
        </ng-container>

        <!-- text -->
        <ng-container *ngIf="node.type==='text'">
          <ion-item>
            <ion-input placeholder="Введіть відповідь" [value]="answers[node.step_type]"
                       (ionInput)="setText(node.step_type, $any($event.target).value)"></ion-input>
          </ion-item>
        </ng-container>

        <!-- city select для offline -->
        <ng-container *ngIf="node.step_type==='format' && answers['format']==='offline' && node.cities">
          <ion-item>
            <ion-select placeholder="Оберіть місто" [value]="answers.city_id" (ionChange)="setCity($event.detail.value)">
              <ion-select-option *ngFor="let c of node.cities" [value]="c.city_id">{{ c.name }}</ion-select-option>
            </ion-select>
          </ion-item>
        </ng-container>
      </ion-list>

      <ion-footer>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button (click)="prevStep()">Назад</ion-button>
          </ion-buttons>
          <ion-buttons slot="end" *ngIf="node && !node.is_final">
            <ion-button [disabled]="!validate(node)" (click)="nextStep()">Далі</ion-button>
          </ion-buttons>
          <ion-buttons slot="end" *ngIf="node && node.is_final">
            <ion-button color="primary" [disabled]="!validate(node)" (click)="submit()">Отримати результат</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-footer>
    </ng-container>

    <!-- Результати -->
    <ng-container *ngSwitchCase="'results'">
      <ion-header>
        <ion-toolbar>
          <ion-title>Підібрані психологи</ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <div class="psychologist-cards-container">
          <ng-container *ngFor="let doctor of results">
            <div class="psychologist-card">
              <div class="card-header">
                <img [src]="doctor.avatarUrl || 'assets/img/IMG_1743.jpeg'" alt="Psychologist" class="psychologist-avatar">
                <div class="header-info">
                  <div class="online-offline-status">
                    <span *ngIf="doctor.online" class="status-item online">
                      <ion-icon src="assets/icon/onlain.svg"></ion-icon>
                      Онлайн
                    </span>
                    <span *ngIf="doctor.inPerson" class="status-item offline">
                      <ion-icon src="assets/icon/ochno.svg"></ion-icon>
                      Очно
                    </span>
                  </div>
                  <p *ngIf="doctor.city" class="location">{{ doctor.city }}</p>
                  <h3 class="psychologist-name">{{ doctor.fullName }}</h3>
                  <p *ngIf="doctor.verified" class="verified-specialist">
                    <ion-icon src="assets/icon/verified.svg"></ion-icon>
                    Перевірений фахівець
                  </p>
                </div>
              </div>
              <p *ngIf="doctor.specialization" class="specialization">{{ doctor.specialization }}</p>
              <div class="stats">
                <span *ngIf="doctor.experienceYears" class="stat-item">
                  <ion-icon src="assets/icon/praktika.svg"></ion-icon>
                  {{ doctor.experienceYears }} років практики
                </span>
                <span *ngIf="doctor.sessionsCount" class="stat-item">
                  <ion-icon src="assets/icon/session.svg"></ion-icon>
                  {{ doctor.sessionsCount }}+ сесій
                </span>
              </div>
              <div class="feedback-and-intro">
                <span *ngIf="doctor?.reviewsCountText" class="feedback-item">
                  <ion-icon src="assets/icon/otzyv.svg"></ion-icon>
                  {{ doctor?.reviewsCountText }}
                </span>
                <span *ngIf="doctor.introMinutes" class="intro-item">
                  <ion-icon src="assets/icon/hello.svg"></ion-icon>
                  Знайомство {{ doctor.introMinutes }} хв
                </span>
              </div>
              <div class="pricing-and-profile">
                <div class="pricing">
                  <div *ngIf="doctor.priceIndividual" class="price-item">
                    <p style="font-size: 14px; color: #9895a6; font-weight: 400;">Індивідуальна</p>
                    <p class="price-value" style="color: #2f264d; font-size: 20px; font-weight: 500;">{{ doctor.priceIndividual }} <span class="currency" style="font-size: 14px; color: #9895a6; font-weight: 400;">грн.</span></p>
                  </div>
                  <div *ngIf="doctor.priceFamily" class="price-item">
                    <p style="font-size: 14px; color: #9895a6; font-weight: 400;">Сімейна</p>
                    <p class="price-value" style="color: #2f264d; font-size: 20px; font-weight: 500;">{{ doctor.priceFamily }} <span class="currency" style="font-size: 14px; color: #9895a6; font-weight: 400;">грн.</span></p>
                  </div>
                </div>
                <ion-button class="profile-button" (click)="goToProfile(doctor.id)">В профіль</ion-button>
              </div>
            </div>
          </ng-container>
        </div>
      </ion-content>

      <ion-footer>
        <ion-toolbar>
          <ion-button expand="block" (click)="resetAll()">Спробувати ще раз</ion-button>
        </ion-toolbar>
      </ion-footer>
    </ng-container>

  </ng-container>
</ion-content>
